<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é†«ç™‚è¼”å…·ç›£æ§ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@latest/dist/browser/signalr.min.js"></script>
    <link rel="stylesheet" href ="styles.css" >
</head>
<body>
    <div class="container">
        <h1>ğŸ¥ é†«ç™‚è¼”å…·å³æ™‚ç›£æ§ç³»çµ±</h1>
        
        <div>
            <span id="connectionStatus" class="status disconnected">æœªé€£æ¥</span>
            <button onclick="connect()">é€£æ¥</button>
            <button onclick="disconnect()">æ–·é–‹</button>
            <button onclick="subscribeAll()">è¨‚é–±æ‰€æœ‰è¨­å‚™</button>
        </div>

        <div id="alerts"></div>
        
        <h2>è¨­å‚™ç›£æ§</h2>
        <div id="devices"></div>
    </div>

    <script>
        let connection = null;
        const deviceData = {};

        function connect() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("http://localhost:5278/medicalhub")
                .withAutomaticReconnect()
                .configureLogging(signalR.LogLevel.Information)
                .build();

            connection.on("Connected", (data) => {
                console.log("é€£æ¥æˆåŠŸ:", data);
                document.getElementById("connectionStatus").textContent = "å·²é€£æ¥";
                document.getElementById("connectionStatus").className = "status connected";
            });

            connection.on("ReceiveDeviceData", (data) => {
                console.log("æ”¶åˆ°è¨­å‚™æ•¸æ“š:", data);
                updateDeviceDisplay(data);
            });

            connection.on("AbnormalDataAlert", (data) => {
                console.warn("ç•°å¸¸æ•¸æ“šè­¦å ±:", data);
                showAlert(data);
            });

            connection.on("SubscriptionConfirmed", (data) => {
                console.log("è¨‚é–±ç¢ºèª:", data);
            });

            connection.start()
                .then(() => {
                    console.log("SignalR é€£æ¥å·²å»ºç«‹");
                })
                .catch(err => {
                    console.error("é€£æ¥å¤±æ•—:", err);
                    document.getElementById("connectionStatus").textContent = "é€£æ¥å¤±æ•—";
                });
        }

        function disconnect() {
            if (connection) {
                connection.stop();
                document.getElementById("connectionStatus").textContent = "æœªé€£æ¥";
                document.getElementById("connectionStatus").className = "status disconnected";
            }
        }

        function subscribeAll() {
            if (connection) {
                connection.invoke("SubscribeToDevice", "BP001", "P001");
                connection.invoke("SubscribeToDevice", "HR001", "P001");
                connection.invoke("SubscribeToDevice", "OX001", "P001");
                connection.invoke("SubscribeToDevice", "TH001", "P001");
            }
        }

        function updateDeviceDisplay(data) {
            const devicesDiv = document.getElementById("devices");
            const deviceKey = data.deviceId;
            
            if (!deviceData[deviceKey]) {
                deviceData[deviceKey] = document.createElement("div");
                deviceData[deviceKey].className = "device-card";
                deviceData[deviceKey].id = `device-${deviceKey}`;
                devicesDiv.appendChild(deviceData[deviceKey]);
            }

            const card = deviceData[deviceKey];
            card.className = data.isAbnormal ? "device-card abnormal" : "device-card";
            card.innerHTML = `
                <h3>${data.deviceType} (${data.deviceId})</h3>
                <div class="value">${data.value} ${data.unit}</div>
                <p><strong>æ¸¬é‡é¡å‹:</strong> ${data.measurementType}</p>
                <p><strong>æ‚£è€…ID:</strong> ${data.patientId}</p>
                <p><strong>æ™‚é–“:</strong> ${new Date(data.timestamp).toLocaleString('zh-TW')}</p>
                <p><strong>å‚™è¨»:</strong> ${data.notes}</p>
            `;
        }

        function showAlert(data) {
            const alertsDiv = document.getElementById("alerts");
            const alert = document.createElement("div");
            alert.className = "alert";
            alert.innerHTML = `
                âš ï¸ <strong>ç•°å¸¸è­¦å ±!</strong> ${data.deviceType} - ${data.measurementType}: ${data.value} ${data.unit}<br>
                ${data.notes}
            `;
            alertsDiv.appendChild(alert);

            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        window.onload = function() {
            connect();
            setTimeout(subscribeAll, 1000);
        };
    </script>
</body>
</html>