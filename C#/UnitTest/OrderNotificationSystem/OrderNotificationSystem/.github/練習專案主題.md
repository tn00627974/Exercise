
---

# ä¸€ã€ç·´ç¿’å°ˆæ¡ˆä¸»é¡Œï¼ˆç°¡å–®åˆçœŸå¯¦ï¼‰

**DI / interface / NUnit æœƒä¸€æ¬¡å…¨éƒ¨æ‰“é€š**ã€‚

1ï¸âƒ£ ç·´ç¿’å°ˆæ¡ˆçš„ã€Œæ•…äº‹èƒŒæ™¯ã€  
2ï¸âƒ£ å°ˆæ¡ˆçµæ§‹  
3ï¸âƒ£ å®Œæ•´ç¨‹å¼ç¢¼ï¼ˆå¯ç›´æ¥å»ºç«‹ï¼‰  
4ï¸âƒ£ ç·´ç¿’æ­¥é©Ÿï¼ˆä½ ç…§é †åºåšï¼‰

ä¸æœƒç”¨ ASP.NETã€ä¸ç”¨å®¹å™¨ï¼Œ**å…ˆç”¨æœ€ç´”çš„ DI æ€ç¶­**ã€‚

## ğŸ¯ ä¸»é¡Œï¼š**è¨‚å–®é€šçŸ¥ç³»çµ±**

éœ€æ±‚åªæœ‰ä¸€å¥è©±ï¼š

> ä¸‹è¨‚å–®å¾Œï¼Œç³»çµ±è¦ã€Œç™¼é€é€šçŸ¥ã€

é€šçŸ¥æ–¹å¼æœªä¾†å¯èƒ½æœ‰ï¼š

- Email    
- Line    
- ç°¡è¨Š    

ğŸ‘‰ **é€™éå¸¸é©åˆç·´ interface + DI + NUnit**

---

# äºŒã€å°ˆæ¡ˆçµæ§‹ï¼ˆç…§é€™å€‹å»ºï¼‰

å»ºç«‹ä¸€å€‹ **Solution**

```
OrderNotificationDemo
â”‚
â”œâ”€ OrderNotification.Core
â”‚   â”œâ”€ INotificationSender.cs
â”‚   â”œâ”€ Order.cs
â”‚   â”œâ”€ NotificationResult.cs
â”‚   â”œâ”€ EmailNotificationSender.cs
â”‚   â””â”€ OrderService.cs
â”‚
â””â”€ OrderNotification.Tests
    â”œâ”€ FakeNotificationSender.cs
    â””â”€ OrderServiceTests.cs
```

---

# ä¸‰ã€æ­£å¼ç¨‹å¼ç¢¼ï¼ˆCoreï¼‰

## 1ï¸âƒ£ INotificationSender.csï¼ˆä»‹é¢ï¼‰

```csharp
public interface INotificationSender
{
    NotificationResult Send(Order order);
}
```

---

## 2ï¸âƒ£ Order.csï¼ˆDTOï¼‰

```csharp
public class Order
{
    public string OrderNo { get; set; }
    public decimal Amount { get; set; }
}
```

---

## 3ï¸âƒ£ NotificationResult.cs

```csharp
public class NotificationResult
{
    public bool Success { get; set; }
    public string Message { get; set; }
}
```

---

## 4ï¸âƒ£ EmailNotificationSender.csï¼ˆçœŸå¯¦å¯¦ä½œï¼‰

```csharp
public class EmailNotificationSender : INotificationSender
{
    public NotificationResult Send(Order order)
    {
        // å‡è£åœ¨å¯„ Email
        return new NotificationResult
        {
            Success = true,
            Message = $"Email å·²å¯„å‡ºï¼Œè¨‚å–®ï¼š{order.OrderNo}"
        };
    }
}
```

---

## 5ï¸âƒ£ OrderService.csï¼ˆâ­ é‡é»ï¼‰

```csharp
public class OrderService
{
    private readonly INotificationSender _sender;

    // ğŸ‘‰ DIï¼šå¾å¤–é¢æ³¨å…¥
    public OrderService(INotificationSender sender)
    {
        _sender = sender;
    }

    public NotificationResult PlaceOrder(Order order)
    {
        if (order.Amount <= 0)
        {
            return new NotificationResult
            {
                Success = false,
                Message = "è¨‚å–®é‡‘é¡éŒ¯èª¤"
            };
        }

        return _sender.Send(order);
    }
}
```

ğŸ“Œ **é€™å€‹ class æ˜¯ä½ æ¸¬è©¦çš„æ ¸å¿ƒ**

---

# å››ã€æ¸¬è©¦ç¨‹å¼ç¢¼ï¼ˆNUnitï¼‰

## 6ï¸âƒ£ FakeNotificationSender.csï¼ˆå‡å¯¦ä½œï¼‰

```csharp
public class FakeNotificationSender : INotificationSender
{
    public NotificationResult Send(Order order)
    {
        return new NotificationResult
        {
            Success = true,
            Message = "Fake é€šçŸ¥æˆåŠŸ"
        };
    }
}
```

---

## 7ï¸âƒ£ OrderServiceTests.cs

```csharp
using NUnit.Framework;

[TestFixture]
public class OrderServiceTests
{
    [Test]
    public void PlaceOrder_ValidAmount_ShouldSendNotification()
    {
        // Arrange
        var sender = new FakeNotificationSender();
        var service = new OrderService(sender);

        var order = new Order
        {
            OrderNo = "ORD001",
            Amount = 1000
        };

        // Act
        var result = service.PlaceOrder(order);

        // Assert
        Assert.IsTrue(result.Success);
        Assert.AreEqual("Fake é€šçŸ¥æˆåŠŸ", result.Message);
    }

    [Test]
    public void PlaceOrder_InvalidAmount_ShouldFail()
    {
        // Arrange
        var sender = new FakeNotificationSender();
        var service = new OrderService(sender);

        var order = new Order
        {
            OrderNo = "ORD002",
            Amount = 0
        };

        // Act
        var result = service.PlaceOrder(order);

        // Assert
        Assert.IsFalse(result.Success);
        Assert.AreEqual("è¨‚å–®é‡‘é¡éŒ¯èª¤", result.Message);
    }
}
```

---

# äº”ã€ä½ ç¾åœ¨ã€Œå¯¦éš›å­¸åˆ°ã€çš„æ˜¯ä»€éº¼ï¼Ÿ

### âœ… Interface

- `INotificationSender` æ˜¯åˆç´„
    
- Email / Fake éƒ½å¯ä»¥æ›¿æ›
    

### âœ… DIï¼ˆå»ºæ§‹å¼æ³¨å…¥ï¼‰

- `OrderService` **ä¸è‡ªå·± new**
    
- å¤–é¢æ±ºå®šè¦ç”¨èª°
    

### âœ… NUnit

- ä¸é€£å¤–    
- ä¸é  UI    
- æ¸¬çš„æ˜¯ã€Œè¡Œç‚ºã€
    

---

# å…­ã€å»ºè­°ä½ ç…§é€™å€‹é †åºç·´ï¼ˆå¾ˆé‡è¦ï¼‰

### ğŸ” ç¬¬ 1 é—œï¼ˆç¾åœ¨ï¼‰

âœ” è·‘éæ¸¬è©¦  
âœ” ç¢ºå®šå…¨éƒ¨ç¶ ç‡ˆ

---

### ğŸ” ç¬¬ 2 é—œï¼ˆä½ è‡ªå·±æ”¹ï¼‰

- æ–°å¢ `LineNotificationSender`
    
- ä¸æ”¹ `OrderService`
    
- æ¸¬è©¦ä»ç„¶è¦é
    

---

### ğŸ” ç¬¬ 3 é—œï¼ˆé€²éšï¼‰

- è®“ `FakeNotificationSender` å¯ä»¥ã€ŒæŒ‡å®šæˆåŠŸæˆ–å¤±æ•—ã€    
- æ¸¬å¤±æ•—æƒ…å¢ƒ
    
---

### ğŸ” ç¬¬ 4 é—œï¼ˆé€²éš - ä¾è³´æ³¨å…¥æ·±åŒ–ï¼‰

- æ–°å¢ `IOrderValidator` ä»‹é¢
    
- `OrderService` åŒæ™‚æ³¨å…¥ã€Œé©—è­‰å™¨ã€å’Œã€Œé€šçŸ¥ç™¼é€å™¨ã€
    
- é©—è­‰å¤±æ•—æ™‚ï¼Œä¸å‘¼å« `Send()`
    
- ç”¨ `Substitute` Mock é©—è­‰ `Send()` å‘¼å«æ¬¡æ•¸

**é‡é»å­¸ç¿’ï¼š**
- âœ… å¤šå€‹ä»‹é¢ä¾è³´æ³¨å…¥
- âœ… é—œæ³¨é»åˆ†é›¢ï¼ˆValidation vs Notificationï¼‰
- âœ… Mock é©—è­‰æ–¹æ³•å‘¼å«ï¼ˆ`Received()` / `DidNotReceive()`ï¼‰

---

### ğŸ” ç¬¬ 5 é—œï¼ˆé€²éš - çœŸå¯¦å ´æ™¯ï¼šComposite Patternï¼‰

#### ğŸ“‹ æ–°éœ€æ±‚

è¨‚å–®ä¸‹å–®å¾Œï¼Œæœ‰æ™‚å€™éœ€è¦ã€ŒåŒæ™‚ç™¼é€å¤šå€‹é€šçŸ¥ã€

ä¾‹å¦‚ï¼šåŒæ™‚å¯„ Email **å’Œ** ç™¼é€ Line

#### ğŸ¯ å ´æ™¯æ¡ˆä¾‹

```csharp
// â“ ç¾åœ¨æ€éº¼åŒæ™‚ç”¨é€™å…©å€‹ï¼Ÿ
// OrderService åªèƒ½æ³¨å…¥ä¸€å€‹ INotificationSender...

var emailSender = new EmailNotificationSender();
var lineSender = new LineNotificationSender();

// éœ€è¦åŒæ™‚ç™¼é€ Email å’Œ Line
```

#### ğŸ’¡ è§£æ±ºæ–¹æ¡ˆï¼šComposite Pattern

**å»ºç«‹è¤‡åˆé€šçŸ¥ç™¼é€å™¨ï¼š**

```csharp
// OrderNotificationSystem\CompositeNotificationSender.cs
using System;
using System.Collections.Generic;
using System.Linq;

namespace OrderNotificationSystem
{
    /// <summary>
    /// è¤‡åˆé€šçŸ¥ç™¼é€å™¨ï¼šåŒæ™‚ä½¿ç”¨å¤šå€‹ç™¼é€å™¨
    /// </summary>
    public class CompositeNotificationSender : INotificationSender
    {
        private readonly IEnumerable<INotificationSender> _senders;

        public CompositeNotificationSender(params INotificationSender[] senders)
        {
            _senders = senders;
        }

        public NotificationResult Send(Order order)
        {
            var results = new List<NotificationResult>();
            var failedMessages = new List<string>();

            // é€ä¸€åŸ·è¡Œæ‰€æœ‰ç™¼é€å™¨
            foreach (var sender in _senders)
            {
                try
                {
                    var result = sender.Send(order);
                    results.Add(result);

                    if (!result.Success)
                    {
                        failedMessages.Add(result.Message);
                    }
                }
                catch (Exception ex)
                {
                    failedMessages.Add($"ç™¼é€å¤±æ•—: {ex.Message}");
                }
            }

            // æ±ºå®šæ•´é«”çµæœ
            if (failedMessages.Any())
            {
                return new NotificationResult
                {
                    Success = false,
                    Message = $"éƒ¨åˆ†é€šçŸ¥å¤±æ•—: {string.Join("; ", failedMessages)}"
                };
            }

            return new NotificationResult
            {
                Success = true,
                Message = $"æ‰€æœ‰é€šçŸ¥å·²ç™¼é€ ({results.Count} å€‹)"
            };
        }
    }
}
```

#### ğŸ§ª æ¸¬è©¦æ¡ˆä¾‹

```csharp
// OrderNotificationSystemTests\CompositeNotificationSenderTests.cs
using NSubstitute;
using OrderNotificationSystem;
using OrderNotificationSystem.Models;

namespace OrderNotificationSystemTests
{
    public class CompositeNotificationSenderTests
    {
        [Test]
        public void Send_WithMultipleSenders_AllSuccess()
        {
            // Arrange
            var order = new Order { OrderNo = "ORD001", Amount = 1000 };
            
            var emailSender = Substitute.For<INotificationSender>();
            var lineSender = Substitute.For<INotificationSender>();
            
            emailSender.Send(Arg.Any<Order>()).Returns(new NotificationResult 
            { 
                Success = true, 
                Message = "Email sent" 
            });
            
            lineSender.Send(Arg.Any<Order>()).Returns(new NotificationResult 
            { 
                Success = true, 
                Message = "Line sent" 
            });

            var composite = new CompositeNotificationSender(emailSender, lineSender);

            // Act
            var result = composite.Send(order);

            // Assert
            Assert.That(result.Success, Is.True);
            Assert.That(result.Message, Contains.Substring("2"));
            
            // ğŸ‘‰ é©—è­‰å…©å€‹ç™¼é€å™¨éƒ½è¢«å‘¼å«
            emailSender.Received(1).Send(order);
            lineSender.Received(1).Send(order);
        }

        [Test]
        public void Send_WhenOneSenderFails_ReturnsFailure()
        {
            // Arrange
            var order = new Order { OrderNo = "ORD002", Amount = 500 };
            
            var emailSender = Substitute.For<INotificationSender>();
            var lineSender = Substitute.For<INotificationSender>();
            
            emailSender.Send(Arg.Any<Order>()).Returns(new NotificationResult 
            { 
                Success = true, 
                Message = "Email sent" 
            });
            
            lineSender.Send(Arg.Any<Order>()).Returns(new NotificationResult 
            { 
                Success = false, 
                Message = "Line service down" 
            });

            var composite = new CompositeNotificationSender(emailSender, lineSender);

            // Act
            var result = composite.Send(order);

            // Assert
            Assert.That(result.Success, Is.False);
            Assert.That(result.Message, Contains.Substring("Line service down"));
        }

        [Test]
        public void Send_WithRealSenders_EmailAndLine()
        {
            // Arrange - æ•´åˆæ¸¬è©¦ï¼šä½¿ç”¨çœŸå¯¦å¯¦ä½œ
            var order = new Order { OrderNo = "ORD003", Amount = 1500 };
            
            INotificationSender emailSender = new EmailNotificationSender();
            INotificationSender lineSender = new LineNotificationSender();
            
            var composite = new CompositeNotificationSender(emailSender, lineSender);

            // Act
            var result = composite.Send(order);

            // Assert
            Assert.That(result.Success, Is.True);
            Assert.That(result.Message, Contains.Substring("æ‰€æœ‰é€šçŸ¥å·²ç™¼é€"));
        }
    }
}
```

#### ğŸ¯ ç”¨æ³•ç¤ºä¾‹

**åŸä¾†ï¼ˆåªèƒ½ä¸€å€‹ï¼‰ï¼š**
```csharp
INotificationSender sender = new EmailNotificationSender();
var orderService = new OrderService(_validator, sender);
```

**ç¾åœ¨ï¼ˆå¯ä»¥å¤šå€‹ï¼‰ï¼š**
```csharp
// åŒæ™‚ç™¼é€ Email å’Œ Line
INotificationSender composite = new CompositeNotificationSender(
    new EmailNotificationSender(),
    new LineNotificationSender()
);
var orderService = new OrderService(_validator, composite);
```

#### ğŸ“š ä½ å­¸åˆ°çš„æ–°æ¦‚å¿µ

### âœ… **Composite Patternï¼ˆçµ„åˆæ¨¡å¼ï¼‰**
- `CompositeNotificationSender` æœ¬èº«ä¹Ÿæ˜¯ `INotificationSender`
- å¯ä»¥åŒ…å«å¤šå€‹ `INotificationSender`
- å°å¤–è¡¨ç¾è·Ÿå–®ä¸€ç™¼é€å™¨ä¸€æ¨£ï¼ˆé€æ˜æ€§ï¼‰
- å¯ä»¥ç„¡é™çµ„åˆåµŒå¥—

### âœ… **Exception Handlingï¼ˆç•°å¸¸è™•ç†ï¼‰**
- éƒ¨åˆ†å¤±æ•—ä¸æœƒå°è‡´å…¨éƒ¨å¤±æ•—
- è¨˜éŒ„æ¯å€‹å¤±æ•—çš„åŸå› 
- ä½¿ç”¨ try-catch æ•æ‰ç•°å¸¸

### âœ… **Collectionsï¼ˆé›†åˆï¼‰**
- ä½¿ç”¨ `IEnumerable<T>` å­˜æ”¾å¤šå€‹ä¾è³´
- ä½¿ç”¨ `params` ç°¡åŒ–å»ºæ§‹å­
- ä½¿ç”¨ `Linq` æŸ¥è©¢é›†åˆ

**é‡é»å­¸ç¿’ï¼š**
- âœ… è¨­è¨ˆæ¨¡å¼ï¼šComposite Pattern
- âœ… ç•°å¸¸è™•ç†å’Œå®¹éŒ¯
- âœ… é›†åˆæ“ä½œå’Œè¿´åœˆ

---

# ä¸ƒã€ä¸€å¥æ–°æ‰‹ä¸€å®šè¦è¨˜ä½çš„è©±

> **ã€Œæˆ‘èƒ½ç”¨ Fake æ¸¬è©¦ï¼Œä»£è¡¨æˆ‘æ¶æ§‹æ˜¯å°çš„ã€**

---

# å…«ã€é€²éšä¼æ¥­ç”¨æ³•ï¼ˆé¸ä¿®ï¼‰â­â­â­

ç•¶ä½ å®Œæˆç¬¬é—œå¡å¾Œï¼Œå¯ä»¥å­¸ç¿’ä¼æ¥­æ¨™æº–çš„åšæ³•ã€‚

## ä¼æ¥­æ¨™æº–çš„æ¸¬è©¦çµ„ç¹”æ–¹å¼

### ğŸ“ æ¨è–¦çš„å°ˆæ¡ˆçµæ§‹

```
OrderNotificationSystem/
â”œâ”€ Core/
â”‚   â”œâ”€ INotificationSender.cs
â”‚   â”œâ”€ IOrderValidator.cs
â”‚   â”œâ”€ Order.cs
â”‚   â”œâ”€ NotificationResult.cs
â”‚   â”œâ”€ EmailNotificationSender.cs
â”‚   â”œâ”€ LineNotificationSender.cs
â”‚   â”œâ”€ DefaultOrderValidator.cs
â”‚   â””â”€ OrderService.cs
â”‚
â””â”€ Tests/
    â”œâ”€ Unit/                           # ğŸ‘ˆ å–®å…ƒæ¸¬è©¦è³‡æ–™å¤¾
    â”‚   â”œâ”€ OrderServiceTests.cs
    â”‚   â”œâ”€ DefaultOrderValidatorTests.cs
    â”‚   â””â”€ FakeNotificationSenderTests.cs
    â”‚
    â””â”€ Integration/                    # ğŸ‘ˆ æ•´åˆæ¸¬è©¦è³‡æ–™å¤¾
        â””â”€ OrderServiceIntegrationTests.cs
```

### ğŸ“Š ç‚ºä»€éº¼è¦åˆ†é–‹ï¼Ÿ

| é …ç›® | å–®å…ƒæ¸¬è©¦ | æ•´åˆæ¸¬è©¦ |
|------|---------|---------|
| **æª”æ¡ˆä½ç½®** | `Tests/Unit/` | `Tests/Integration/` |
| **ä½¿ç”¨ Mock** | âœ… Substitute | âŒ ä¸ç”¨ |
| **ä½¿ç”¨çœŸå¯¦é¡** | âŒ éš”é›¢ | âœ… çœŸå¯¦å¯¦ä½œ |
| **åŸ·è¡Œé€Ÿåº¦** | âš¡ å¿«ï¼ˆç§’ç´šï¼‰ | ğŸŒ æ…¢ï¼ˆåˆ†é˜ç´šï¼‰ |
| **åŸ·è¡Œæ™‚æ©Ÿ** | æ¯æ¬¡å­˜æª” | å®šæœŸ/æäº¤å‰ |
| **è¦†è“‹ç¯„åœ** | å–®ä¸€é¡åˆ¥/æ–¹æ³• | å¤šå€‹é¡åˆ¥å”ä½œ |

### âœ… å–®å…ƒæ¸¬è©¦ç¯„ä¾‹ï¼šOrderServiceTests.cs

```csharp
using NSubstitute;
using OrderNotificationSystem.Models;
using OrderNotificationSystem;

namespace OrderNotificationSystemTests.Unit
{
    public class OrderServiceTests
    {
        private INotificationSender _mockSender;
        private IOrderValidator _mockValidator;

        [SetUp]
        public void Setup()
        {
            _mockSender = Substitute.For<INotificationSender>();
            _mockValidator = Substitute.For<IOrderValidator>();
        }

        [Test]
        public void PlaceOrder_When_ValidatorPasses_ShouldCallSender()
        {
            // Arrange - ç”¨ Mock éš”é›¢ä¾è³´
            var order = new Order { OrderNo = "order001", Amount = 100 };
            _mockValidator.Validate(Arg.Any<Order>()).Returns(new NotificationResult 
            { 
                Success = true, 
                Message = "é©—è­‰é€šé" 
            });

            var orderService = new OrderService(_mockValidator, _mockSender);

            // Act
            var result = orderService.PlaceOrder(order);

            // Assert
            Assert.That(result.Success, Is.True);
            
            // ğŸ‘‰ é©—è­‰è¡Œç‚ºï¼šSend è¢«å‘¼å« 1 æ¬¡
            _mockSender.Received(1).Send(order);
        }

        [Test]
        public void PlaceOrder_When_ValidatorFails_ShouldNotCallSender()
        {
            // Arrange - é©—è­‰å¤±æ•—çš„æƒ…æ³
            var order = new Order { OrderNo = "order001", Amount = -100 };
            _mockValidator.Validate(Arg.Any<Order>()).Returns(new NotificationResult 
            { 
                Success = false, 
                Message = "è¨‚å–®éŒ¯èª¤" 
            });

            var orderService = new OrderService(_mockValidator, _mockSender);

            // Act
            var result = orderService.PlaceOrder(order);

            // Assert
            Assert.That(result.Success, Is.False);
            
            // ğŸ‘‰ é©—è­‰è¡Œç‚ºï¼šSend æ²’æœ‰è¢«å‘¼å«
            _mockSender.DidNotReceive().Send(Arg.Any<Order>());
        }
    }
}
```

### âœ… æ•´åˆæ¸¬è©¦ç¯„ä¾‹ï¼šOrderServiceIntegrationTests.cs

```csharp
using OrderNotificationSystem.Models;
using OrderNotificationSystem;

namespace OrderNotificationSystemTests.Integration
{
    public class OrderServiceIntegrationTests
    {
        [Test]
        public void PlaceOrder_WithRealValidator_AndRealEmailSender_CompleteFlow()
        {
            // Arrange - ä½¿ç”¨çœŸå¯¦å¯¦ä½œï¼Œä¸ç”¨ Mock
            var order = new Order { OrderNo = "ORD-2024-001", Amount = 1000 };
            IOrderValidator validator = new DefaultOrderValidator();
            INotificationSender sender = new EmailNotificationSender();
            var orderService = new OrderService(validator, sender);

            // Act - åŸ·è¡Œå®Œæ•´æµç¨‹
            var result = orderService.PlaceOrder(order);

            // Assert - é©—è­‰ç«¯å°ç«¯æµç¨‹
            Assert.That(result.Success, Is.True);
            Assert.That(result.Message, Is.EqualTo($"è¨‚å–®é‡‘é¡ç‚º{order.Amount}å…ƒ"));
        }

        [Test]
        public void PlaceOrder_WithRealValidator_AndRealLineSender_CompleteFlow()
        {
            // Arrange - ä½¿ç”¨çœŸå¯¦å¯¦ä½œæ¸¬è©¦ä¸åŒç™¼é€è€…
            var order = new Order { OrderNo = "ORD-2024-002", Amount = 500 };
            IOrderValidator validator = new DefaultOrderValidator();
            INotificationSender sender = new LineNotificationSender();
            var orderService = new OrderService(validator, sender);

            // Act
            var result = orderService.PlaceOrder(order);

            // Assert
            Assert.That(result.Success, Is.True);
            Assert.That(result.Message, Is.EqualTo($"è¨‚å–®é‡‘é¡ç‚º{order.Amount}å…ƒ"));
        }

        [Test]
        public void PlaceOrder_WithInvalidAmount_FailsValidation()
        {
            // Arrange - æ•´åˆæ¸¬è©¦é©—è­‰æµç¨‹ï¼šé©—è­‰å¤±æ•— â†’ ä¸ç™¼é€
            var order = new Order { OrderNo = "ORD-2024-003", Amount = -100 };
            IOrderValidator validator = new DefaultOrderValidator();
            INotificationSender sender = new EmailNotificationSender();
            var orderService = new OrderService(validator, sender);

            // Act
            var result = orderService.PlaceOrder(order);

            // Assert - é©—è­‰æ•´å€‹æµç¨‹çš„è¡Œç‚º
            Assert.That(result.Success, Is.False);
            Assert.That(result.Message, Is.EqualTo("è¨‚å–®éŒ¯èª¤"));
        }
    }
}
```

### ğŸ¯ æ¸¬è©¦é‡‘å­—å¡”

```
        ğŸ“Š E2E æ¸¬è©¦
       /            \
      å°‘é‡         (1å€‹)
     /                  \
    æ•´åˆæ¸¬è©¦           (å°‘é‡)
   /                      \
  å–®å…ƒæ¸¬è©¦              (å¤§é‡ â­)
 /____________________________\

æ¯”ä¾‹ï¼š
- å–®å…ƒæ¸¬è©¦ 80%  â†’ å¿«é€Ÿåé¥‹ï¼Œæ¯æ¬¡å­˜æª”åŸ·è¡Œ
- æ•´åˆæ¸¬è©¦ 15%  â†’ é©—è­‰å”ä½œï¼Œæäº¤å‰åŸ·è¡Œ
- E2E æ¸¬è©¦ 5%   â†’ å®Œæ•´æµç¨‹ï¼Œéƒ¨ç½²å‰åŸ·è¡Œ
```

### âœ¨ ä¼æ¥­åšæ³•å„ªå‹¢

âœ… **å¿«é€Ÿé–‹ç™¼**
- åªåŸ·è¡Œå–®å…ƒæ¸¬è©¦ï¼šç§’ç´šåé¥‹
- ç«‹å³ç™¼ç¾é‚è¼¯å•é¡Œ

âœ… **å¯é éƒ¨ç½²**
- å–®å…ƒæ¸¬è©¦ âœ“ + æ•´åˆæ¸¬è©¦ âœ“ = é«˜ä¿¡å¿ƒ
- æ¸…æ¥šçŸ¥é“å•é¡Œåœ¨å“ªä¸€å±¤

âœ… **æ˜“æ–¼ç¶­è­·**
- æ¸¬è©¦è·è²¬æ¸…æ™°
- æ¯å€‹è³‡æ–™å¤¾ä¸€å€‹ç›®çš„

âœ… **æŒçºŒæ•´åˆ**
- CI/CD å¯åˆ†éšæ®µåŸ·è¡Œ
- å¿«é€Ÿå¤±æ•—ï¼ˆfail fastï¼‰

### ğŸš€ å¦‚ä½•å¯¦æ–½

1. **å»ºç«‹è³‡æ–™å¤¾çµæ§‹**
   ```
   Tests/
   â”œâ”€â”€ Unit/
   â””â”€â”€ Integration/
   ```

2. **é·ç§»ç¾æœ‰æ¸¬è©¦**
   - Mock çš„ â†’ `Unit/`
   - çœŸå¯¦å¯¦ä½œ â†’ `Integration/`

3. **è¨­å®šæ¸¬è©¦åŸ·è¡Œ**
   ```bash
   # å¿«é€Ÿåé¥‹ï¼ˆé–‹ç™¼ä¸­ï¼‰
   dotnet test --filter "Category=Unit"
   
   # å®Œæ•´æ¸¬è©¦ï¼ˆæäº¤å‰ï¼‰
   dotnet test
   ```

4. **åœ¨ CI/CD ä¸­ä½¿ç”¨**
   ```yaml
   # é–‹ç™¼éšæ®µï¼šåªè·‘å–®å…ƒæ¸¬è©¦ï¼ˆå¿«ï¼‰
   jobs:
     - script: dotnet test --filter "Category=Unit"
   
   # éƒ¨ç½²å‰ï¼šè·‘å…¨éƒ¨æ¸¬è©¦ï¼ˆå®Œæ•´ï¼‰
     - script: dotnet test
   ```

---

### ğŸ” ç¬¬ 6 é—œï¼ˆé€²éš - è¨­è¨ˆæ¨¡å¼ï¼šDecorator Patternï¼‰

#### ğŸ“‹ æ–°éœ€æ±‚

ç¾åœ¨ç³»çµ±éœ€è¦ç‚ºæ¯å€‹ç™¼é€å™¨æ·»åŠ é¡å¤–åŠŸèƒ½ï¼Œä½†ä½ **ä¸æƒ³ä¿®æ”¹ç¾æœ‰çš„ EmailNotificationSender æˆ– LineNotificationSender**ã€‚

éœ€è¦æ·»åŠ çš„åŠŸèƒ½ï¼š
1. **æ—¥èªŒåŠŸèƒ½** - è¨˜éŒ„æ¯æ¬¡ç™¼é€
2. **é‡è©¦æ©Ÿåˆ¶** - å¤±æ•—æ™‚è‡ªå‹•é‡è©¦
3. **è¶…æ™‚æ§åˆ¶** - é¿å…ç™¼é€å™¨å¡ä½

#### âŒ ä¸å¥½çš„åšæ³•

```csharp
public class EmailNotificationSender : INotificationSender
{
    public NotificationResult Send(Order order)
    {
        // åŸæœ‰é‚è¼¯
        // + æ—¥èªŒä»£ç¢¼
        // + é‡è©¦ä»£ç¢¼
        // + è¶…æ™‚ä»£ç¢¼
        // ğŸ”´ ä»£ç¢¼è†¨è„¹ã€è·è²¬æ··äº‚
    }
}
```

#### âœ… å¥½çš„åšæ³•ï¼šä½¿ç”¨è£é£¾å™¨æ¨¡å¼

```csharp
var sender = new EmailNotificationSender();
var withLog = new LoggingNotificationSenderDecorator(sender);
var withRetry = new RetryNotificationSenderDecorator(withLog);
var withTimeout = new TimeoutNotificationSenderDecorator(withRetry);

var result = withTimeout.Send(order);  // è‡ªå‹•åŸ·è¡Œï¼šè¶…æ™‚ â†’ é‡è©¦ â†’ æ—¥èªŒ â†’ åŸå§‹ç™¼é€å™¨
```

#### ğŸ’¡ å¯¦ç¾ä»£ç¢¼

##### 1ï¸âƒ£ LoggingNotificationSenderDecorator.cs

```csharp
using System;

namespace OrderNotificationSystem.Decorators
{
    /// <summary>
    /// æ—¥èªŒè£é£¾å™¨ï¼šè¨˜éŒ„æ¯æ¬¡ç™¼é€çš„æƒ…æ³
    /// </summary>
    public class LoggingNotificationSenderDecorator : INotificationSender
    {
        private readonly INotificationSender _innerSender;

        public LoggingNotificationSenderDecorator(INotificationSender innerSender)
        {
            _innerSender = innerSender ?? throw new ArgumentNullException(nameof(innerSender));
        }

        public NotificationResult Send(Order order)
        {
            var senderType = _innerSender.GetType().Name;
            
            // è¨˜éŒ„é–‹å§‹
            Console.WriteLine($"[LOG] é–‹å§‹ç™¼é€é€šçŸ¥ - ç™¼é€å™¨: {senderType}, è¨‚å–®: {order.OrderNo}");

            try
            {
                var result = _innerSender.Send(order);
                
                // è¨˜éŒ„çµæœ
                var status = result.Success ? "æˆåŠŸ" : "å¤±æ•—";
                Console.WriteLine($"[LOG] ç™¼é€{status} - ç™¼é€å™¨: {senderType}, è¨Šæ¯: {result.Message}");

                return result;
            }
            catch (Exception ex)
            {
                // è¨˜éŒ„ç•°å¸¸
                Console.WriteLine($"[LOG] ç™¼é€ç•°å¸¸ - ç™¼é€å™¨: {senderType}, ç•°å¸¸: {ex.Message}");
                throw;
            }
        }
    }
}
```

##### 2ï¸âƒ£ RetryNotificationSenderDecorator.cs

```csharp
using System;

namespace OrderNotificationSystem.Decorators
{
    /// <summary>
    /// é‡è©¦è£é£¾å™¨ï¼šå¤±æ•—æ™‚è‡ªå‹•é‡è©¦
    /// </summary>
    public class RetryNotificationSenderDecorator : INotificationSender
    {
        private readonly INotificationSender _innerSender;
        private readonly int _maxRetries;
        private readonly int _delayMs;

        public RetryNotificationSenderDecorator(
            INotificationSender innerSender, 
            int maxRetries = 3, 
            int delayMs = 100)
        {
            _innerSender = innerSender ?? throw new ArgumentNullException(nameof(innerSender));
            _maxRetries = maxRetries;
            _delayMs = delayMs;
        }

        public NotificationResult Send(Order order)
        {
            int attemptCount = 0;
            Exception lastException = null;

            while (attemptCount < _maxRetries)
            {
                try
                {
                    attemptCount++;
                    var result = _innerSender.Send(order);

                    if (result.Success)
                    {
                        if (attemptCount > 1)
                        {
                            Console.WriteLine($"[RETRY] ç¬¬ {attemptCount} æ¬¡å˜—è©¦æˆåŠŸ");
                        }
                        return result;
                    }
                    else
                    {
                        // å¤±æ•—ï¼Œå¦‚æœé‚„æœ‰é‡è©¦æ¬¡æ•¸å‰‡ç¹¼çºŒ
                        if (attemptCount < _maxRetries)
                        {
                            Console.WriteLine($"[RETRY] ç¬¬ {attemptCount} æ¬¡å¤±æ•—ï¼Œæº–å‚™é‡è©¦... è¨Šæ¯: {result.Message}");
                            System.Threading.Thread.Sleep(_delayMs);
                        }
                        else
                        {
                            return result;
                        }
                    }
                }
                catch (Exception ex)
                {
                    lastException = ex;
                    
                    if (attemptCount < _maxRetries)
                    {
                        Console.WriteLine($"[RETRY] ç¬¬ {attemptCount} æ¬¡ç•°å¸¸ï¼Œæº–å‚™é‡è©¦... ç•°å¸¸: {ex.Message}");
                        System.Threading.Thread.Sleep(_delayMs);
                    }
                }
            }

            // å¦‚æœèµ°åˆ°é€™è£¡è¡¨ç¤ºå…¨éƒ¨é‡è©¦éƒ½å¤±æ•—äº†
            return new NotificationResult
            {
                Success = false,
                Message = $"ç¶“é {_maxRetries} æ¬¡é‡è©¦ä»ç„¶å¤±æ•—ã€‚æœ€å¾Œç•°å¸¸: {lastException?.Message}"
            };
        }
    }
}
```

##### 3ï¸âƒ£ TimeoutNotificationSenderDecorator.cs

```csharp
using System;
using System.Threading;
using System.Threading.Tasks;

namespace OrderNotificationSystem.Decorators
{
    /// <summary>
    /// è¶…æ™‚è£é£¾å™¨ï¼šé¿å…ç™¼é€å™¨åŸ·è¡Œéé•·æ™‚é–“
    /// </summary>
    public class TimeoutNotificationSenderDecorator : INotificationSender
    {
        private readonly INotificationSender _innerSender;
        private readonly int _timeoutMs;

        public TimeoutNotificationSenderDecorator(INotificationSender innerSender, int timeoutMs = 5000)
        {
            _innerSender = innerSender ?? throw new ArgumentNullException(nameof(innerSender));
            _timeoutMs = timeoutMs;
        }

        public NotificationResult Send(Order order)
        {
            try
            {
                // ä½¿ç”¨ Task å’Œ Wait å¯¦ç¾è¶…æ™‚æ§åˆ¶
                var task = Task.Run(() => _innerSender.Send(order));
                
                if (task.Wait(TimeSpan.FromMilliseconds(_timeoutMs)))
                {
                    return task.Result;
                }
                else
                {
                    Console.WriteLine($"[TIMEOUT] ç™¼é€è¶…æ™‚ (>{_timeoutMs}ms)ï¼Œè¨‚å–®: {order.OrderNo}");
                    return new NotificationResult
                    {
                        Success = false,
                        Message = $"ç™¼é€è¶…æ™‚ï¼Œè¶…é {_timeoutMs}ms"
                    };
                }
            }
            catch (AggregateException ex)
            {
                return new NotificationResult
                {
                    Success = false,
                    Message = $"è¶…æ™‚æ§åˆ¶ç•°å¸¸: {ex.InnerException?.Message}"
                };
            }
        }
    }
}
```

#### ğŸ§ª å–®å…ƒæ¸¬è©¦ç¯„ä¾‹

##### LoggingDecoratorTests.cs

```csharp
using NSubstitute;
using NUnit.Framework;
using OrderNotificationSystem;
using OrderNotificationSystem.Decorators;
using OrderNotificationSystem.Models;

namespace OrderNotificationSystemTests.Unit.Decorators
{
    public class LoggingDecoratorTests
    {
        private INotificationSender _mockSender;
        private LoggingNotificationSenderDecorator _decorator;

        [SetUp]
        public void Setup()
        {
            _mockSender = Substitute.For<INotificationSender>();
            _decorator = new LoggingNotificationSenderDecorator(_mockSender);
        }

        [Test]
        public void Send_WhenInnerSenderSucceeds_PassesThroughResult()
        {
            // Arrange
            var order = new Order { OrderNo = "ORD001", Amount = 1000 };
            var expectedResult = new NotificationResult 
            { 
                Success = true, 
                Message = "Sent successfully" 
            };
            
            _mockSender.Send(order).Returns(expectedResult);

            // Act
            var result = _decorator.Send(order);

            // Assert
            Assert.That(result.Success, Is.True);
            Assert.That(result.Message, Is.EqualTo("Sent successfully"));
            _mockSender.Received(1).Send(order);
        }

        [Test]
        public void Send_WhenInnerSenderFails_PassesFailureThrough()
        {
            // Arrange
            var order = new Order { OrderNo = "ORD002", Amount = 100 };
            var expectedResult = new NotificationResult 
            { 
                Success = false, 
                Message = "Send failed" 
            };
            
            _mockSender.Send(order).Returns(expectedResult);

            // Act
            var result = _decorator.Send(order);

            // Assert
            Assert.That(result.Success, Is.False);
            Assert.That(result.Message, Is.EqualTo("Send failed"));
        }
    }
}
```

##### RetryDecoratorTests.cs

```csharp
using NSubstitute;
using NUnit.Framework;
using OrderNotificationSystem;
using OrderNotificationSystem.Decorators;
using OrderNotificationSystem.Models;

namespace OrderNotificationSystemTests.Unit.Decorators
{
    public class RetryDecoratorTests
    {
        private INotificationSender _mockSender;
        private RetryNotificationSenderDecorator _decorator;

        [SetUp]
        public void Setup()
        {
            _mockSender = Substitute.For<INotificationSender>();
            _decorator = new RetryNotificationSenderDecorator(_mockSender, maxRetries: 3, delayMs: 10);
        }

        [Test]
        public void Send_FirstAttemptSucceeds_ReturnSuccess()
        {
            // Arrange
            var order = new Order { OrderNo = "ORD001", Amount = 1000 };
            var expectedResult = new NotificationResult 
            { 
                Success = true, 
                Message = "Success on first try" 
            };
            
            _mockSender.Send(order).Returns(expectedResult);

            // Act
            var result = _decorator.Send(order);

            // Assert
            Assert.That(result.Success, Is.True);
            _mockSender.Received(1).Send(order);
        }

        [Test]
        public void Send_FailsThenSucceeds_RetryUntilSuccess()
        {
            // Arrange
            var order = new Order { OrderNo = "ORD002", Amount = 500 };
            var failResult = new NotificationResult { Success = false, Message = "Temporary failure" };
            var successResult = new NotificationResult { Success = true, Message = "Success after retry" };
            
            _mockSender.Send(order)
                .Returns(failResult)      // ç¬¬ 1 æ¬¡å¤±æ•—
                .AndThen(successResult);  // ç¬¬ 2 æ¬¡æˆåŠŸ

            // Act
            var result = _decorator.Send(order);

            // Assert
            Assert.That(result.Success, Is.True);
            _mockSender.Received(2).Send(order);
        }

        [Test]
        public void Send_FailsAllAttempts_ReturnFailure()
        {
            // Arrange
            var order = new Order { OrderNo = "ORD003", Amount = 100 };
            var failResult = new NotificationResult { Success = false, Message = "Always fails" };
            
            _mockSender.Send(order).Returns(failResult);

            // Act
            var result = _decorator.Send(order);

            // Assert
            Assert.That(result.Success, Is.False);
            Assert.That(result.Message, Contains.Substring("3 æ¬¡é‡è©¦"));
            _mockSender.Received(3).Send(order);
        }
    }
}
```

#### ğŸ“š ä½ å­¸åˆ°çš„æ–°æ¦‚å¿µ

### âœ… **Decorator Patternï¼ˆè£é£¾å™¨æ¨¡å¼ï¼‰**
- å‹•æ…‹æ·»åŠ åŠŸèƒ½è€Œä¸ä¿®æ”¹åŸæœ‰ä»£ç¢¼
- **é–‹æ”¾-é–‰åˆåŸå‰‡ï¼ˆOpen/Closed Principleï¼‰**
- çµ„ä»¶å¯ä»¥ä»»æ„çµ„åˆå †ç–Š
- è²¬ä»»éˆçš„è®ŠåŒ–å½¢å¼

### âœ… **è·è²¬å–®ä¸€ï¼ˆSingle Responsibilityï¼‰**
- `LoggingDecorator` åªè² è²¬æ—¥èªŒ
- `RetryDecorator` åªè² è²¬é‡è©¦
- `TimeoutDecorator` åªè² è²¬è¶…æ™‚
- å„å¸å…¶è·ï¼Œæ˜“æ–¼æ¸¬è©¦å’Œç¶­è­·

### âœ… **Advanced Mock æŠ€å·§**
- `Returns().AndThen()` - æ¨¡æ“¬å¤šæ¬¡èª¿ç”¨è¿”å›ä¸åŒçµæœ
- `Throws()` - æ¨¡æ“¬ç•°å¸¸æƒ…æ³
- é©—è­‰å‘¼å«æ¬¡æ•¸

### âœ… **å¯¦ç”¨çš„å®¹éŒ¯è¨­è¨ˆ**
- æ—¥èªŒç”¨æ–¼æ’æŸ¥å•é¡Œ
- é‡è©¦ç”¨æ–¼æš«æ™‚æ€§æ•…éšœ
- è¶…æ™‚ç”¨æ–¼é¿å…ç¨‹å¼å¡æ­»

#### ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

```csharp
// åŸºæœ¬ç”¨æ³•
var emailSender = new EmailNotificationSender();
var withLog = new LoggingNotificationSenderDecorator(emailSender);
var withRetry = new RetryNotificationSenderDecorator(withLog, maxRetries: 3);
var withTimeout = new TimeoutNotificationSenderDecorator(withRetry, timeoutMs: 5000);

var order = new Order { OrderNo = "ORD001", Amount = 1000 };
var result = withTimeout.Send(order);
// åŸ·è¡Œé †åºï¼šè¶…æ™‚æ§åˆ¶ â†’ é‡è©¦ â†’ æ—¥èªŒ â†’ åŸå§‹ç™¼é€å™¨
```

```csharp
// åœ¨ OrderService ä¸­ä½¿ç”¨
var validator = new DefaultOrderValidator();

var emailSender = new LoggingNotificationSenderDecorator(
    new RetryNotificationSenderDecorator(
        new EmailNotificationSender(),
        maxRetries: 3
    )
);

var orderService = new OrderService(validator, emailSender);
```

#### ğŸ“ æ¨è–¦çš„å°ˆæ¡ˆçµæ§‹

```
OrderNotificationSystem/
â”œâ”€ INotificationSender.cs
â”œâ”€ Order.cs
â”œâ”€ NotificationResult.cs
â”œâ”€ EmailNotificationSender.cs
â”œâ”€ LineNotificationSender.cs
â”œâ”€ OrderService.cs
â”‚
â””â”€ Decorators/                          # ğŸ‘ˆ æ–°è³‡æ–™å¤¾
    â”œâ”€ LoggingNotificationSenderDecorator.cs
    â”œâ”€ RetryNotificationSenderDecorator.cs
    â””â”€ TimeoutNotificationSenderDecorator.cs

Tests/
â”œâ”€ Unit/
â”‚   â”œâ”€ ...existing tests...
â”‚   â””â”€ Decorators/                      # ğŸ‘ˆ æ–°è³‡æ–™å¤¾
â”‚       â”œâ”€ LoggingDecoratorTests.cs
â”‚       â”œâ”€ RetryDecoratorTests.cs
â”‚       â””â”€ TimeoutDecoratorTests.cs
â”‚
â””â”€ Integration/
    â””â”€ ...existing tests...
```

#### âœ¨ ç¬¬ 6 é—œçš„æŒ‘æˆ°ä»»å‹™

**é›£åº¦ â­â­ï¼š** 
- ä¿®æ”¹ `RetryDecorator`ï¼Œä½¿é‡è©¦å»¶é²ä½¿ç”¨ã€ŒæŒ‡æ•¸é€€é¿ã€
```csharp
// ç¬¬ 1 æ¬¡é‡è©¦ç­‰å¾… 100ms
// ç¬¬ 2 æ¬¡é‡è©¦ç­‰å¾… 200ms (100 * 2)
// ç¬¬ 3 æ¬¡é‡è©¦ç­‰å¾… 400ms (100 * 4)
```

**é›£åº¦ â­â­â­ï¼š**
- å»ºç«‹æ–°çš„ `CacheNotificationSenderDecorator`
  - å¦‚æœ 5 ç§’å…§æ”¶åˆ°ç›¸åŒè¨‚å–®è™Ÿï¼Œä½¿ç”¨å¿«å–çµæœè€Œä¸é‡æ–°ç™¼é€
  - å¯«å‡ºå–®å…ƒæ¸¬è©¦é©—è­‰å¿«å–é‚è¼¯

**é›£åº¦ â­â­â­â­ï¼š**
- å»ºç«‹ `CircuitBreakerDecorator`ï¼ˆç†”æ–·å™¨ï¼‰
  - é€£çºŒå¤±æ•— 5 æ¬¡å¾Œï¼Œè‡ªå‹•åœæ­¢ç™¼é€ï¼ˆé–‹è·¯ï¼‰
  - 30 ç§’å¾Œå˜—è©¦æ¢å¾©ï¼ˆåŠé–‹ï¼‰
  - æˆåŠŸå¾Œå®Œå…¨æ¢å¾©ï¼ˆé–‰åˆï¼‰

---

å¦‚æœä½ é¡˜æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç›´æ¥å‡ºã€Œä½œæ¥­é¡Œã€çµ¦ä½ ï¼Œä¾‹å¦‚ï¼š

- â“ å“ªå€‹åœ°æ–¹ã€Œä¸è©²æŠ½ä»‹é¢ã€    
- ğŸ§ª è«‹ä½ è£œä¸€å€‹æ¸¬è©¦ï¼ˆæˆ‘å¹«ä½ æ”¹ï¼‰    
- ğŸ’£ æˆ‘æ•…æ„å¯«ä¸€å€‹å£ç‰ˆæœ¬ï¼Œè®“ä½ ä¿®
     

ä½ åªè¦èªªï¼š  
ğŸ‘‰ã€Œ**çµ¦æˆ‘ç¬¬ 6 é—œå®Œæˆ**ã€ï¼Œæˆ‘çµ¦ä½ **ç¬¬ 7 é—œï¼šéåŒæ­¥ç·¨ç¨‹ (Async/Await)** æˆ– **ç¬¬ 8 é—œï¼šç™¼ä½ˆ-è¨‚é–±æ¨¡å¼ (Pub/Sub)**